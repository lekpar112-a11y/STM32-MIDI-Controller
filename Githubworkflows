name: Compile STM32 MIDI V19 (Clean & Build)

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Arduino CLI
      uses: arduino/setup-arduino-cli@v1.1.2

    # --- 1. BERSIH-BERSIH TOTAL (SOLUSI ERROR "NOT DECLARED") ---
    # Kita hapus dulu folder MidiV7 lama agar file sampah/ganda hilang.
    # Lalu kita buat folder baru yang dijamin kosong.
    - name: Clean and Prepare
      run: |
        echo "Menghapus folder lama..."
        rm -rf MidiV7
        echo "Membuat folder baru..."
        mkdir -p MidiV7

    # --- 2. TULIS ULANG KODINGAN (CODE INJECTION) ---
    # Kita tulis file .ino baru dari nol. 
    # Dijamin variabel 'MyMidi' ada di tempat yang benar.
    - name: Create Fresh Source Code
      run: |
        cat <<'EOF' > MidiV7/MidiV7.ino
        #include <Arduino.h>
        #include <USBComposite.h>

        // DEKLARASI OBJEK MIDI DI PALING ATAS (WAJIB)
        USBMIDI_ MyMidi;

        // --- PIN DEFINITIONS ---
        #define PIN_LED PB11
        #define SerialBT Serial1 
        
        // Matrix Rows (74HC595)
        #define M_DATA  PB15
        #define M_LATCH PC13
        #define M_CLOCK PC14
        
        // Matrix Cols
        byte colPins[8] = {PB0, PB1, PB3, PB4, PB5, PB6, PB7, PB8};
        
        // CD4051
        #define MUX_S0  PB12
        #define MUX_S1  PB13
        #define MUX_S2  PB14
        #define PIN_MUX_IN PA0
        
        // 74HC165
        #define PIN_165_LOAD PA4
        #define PIN_165_CLK  PA5
        #define PIN_165_DATA PA6
        
        // Analog & Encoder
        #define PIN_JOY_X      PA1
        #define PIN_JOY_Y      PA2
        #define PIN_VELOCITY   PA3
        #define PIN_MASTER_VOL PA7
        #define ENC_A   PA8
        #define ENC_B   PB9
        #define ENC_SW  PB10

        // --- VARIABLES ---
        int globalTranspose = 0;
        int globalOctave = 0;
        bool velocityOn = true;
        int tremoloMode = 0;
        volatile int encoderVal = 0;
        
        bool lastKeyState[8][8]; 
        uint32_t lastBtn165 = 0; 
        int lastFader[8];
        int lastJoyX = -1, lastJoyY = -1, lastVol = -1;
        unsigned long tScan = 0, tAnalog = 0, tLed = 0;

        // --- HELPER FUNCTIONS ---
        void isrEncoder() {
          static uint8_t old_AB = 0;
          old_AB <<= 2;                   
          old_AB |= ( (digitalRead(ENC_A)) | (digitalRead(ENC_B)<<1) );
          old_AB &= 0x0f; 
          if ( old_AB == 0x03 || old_AB == 0x0c ) return;
          if ( old_AB == 0x01 || old_AB == 0x0e || old_AB == 0x08 || old_AB == 0x07 ) encoderVal++;
          else encoderVal--;
        }

        void sendMidi(byte cmd, byte d1, byte d2) {
          if ((cmd & 0xF0) == 0x90) MyMidi.sendNoteOn(0, d1, d2);
          else if ((cmd & 0xF0) == 0x80) MyMidi.sendNoteOff(0, d1, d2);
          else MyMidi.sendControlChange(0, d1, d2);
          
          SerialBT.write(cmd); SerialBT.write(d1); SerialBT.write(d2);
          digitalWrite(PIN_LED, HIGH); tLed = millis();
        }

        // --- SETUP ---
        void setup() {
          afio_cfg_debug_ports(AFIO_DEBUG_SW_ONLY);
          
          // Init Pins
          pinMode(PIN_LED, OUTPUT);
          pinMode(M_DATA, OUTPUT); pinMode(M_LATCH, OUTPUT); pinMode(M_CLOCK, OUTPUT);
          shiftOut(M_DATA, M_CLOCK, LSBFIRST, 0xFF); digitalWrite(M_LATCH, HIGH);
          for(int i=0; i<8; i++) pinMode(colPins[i], INPUT_PULLUP);
          pinMode(MUX_S0, OUTPUT); pinMode(MUX_S1, OUTPUT); pinMode(MUX_S2, OUTPUT); pinMode(PIN_MUX_IN, INPUT);
          pinMode(PIN_165_LOAD, OUTPUT); pinMode(PIN_165_CLK, OUTPUT); pinMode(PIN_165_DATA, INPUT);
          pinMode(PIN_JOY_X, INPUT); pinMode(PIN_JOY_Y, INPUT); pinMode(PIN_VELOCITY, INPUT); pinMode(PIN_MASTER_VOL, INPUT);
          pinMode(ENC_A, INPUT_PULLUP); pinMode(ENC_B, INPUT_PULLUP); pinMode(ENC_SW, INPUT_PULLUP);
          
          attachInterrupt(digitalPinToInterrupt(ENC_A), isrEncoder, CHANGE);
          attachInterrupt(digitalPinToInterrupt(ENC_B), isrEncoder, CHANGE);

          // Init USB MIDI
          USBComposite.setProductId(0x0030);
          MyMidi.registerComponent();
          USBComposite.begin();
          SerialBT.begin(31250);
        }

        // --- SCANNERS ---
        void scanMatrix595() {
          for (int r = 0; r < 8; r++) {
            byte rowData = ~(1 << r); 
            digitalWrite(M_LATCH, LOW); shiftOut(M_DATA, M_CLOCK, LSBFIRST, rowData); digitalWrite(M_LATCH, HIGH);
            for (int c = 0; c < 8; c++) {
              bool pressed = !digitalRead(colPins[c]);
              if (pressed != lastKeyState[r][c]) {
                int note = 36 + (r * 8) + c + (globalOctave * 12) + globalTranspose;
                if (pressed) {
                  int vel = 127;
                  if (velocityOn) {
                    int fsr = analogRead(PIN_VELOCITY);
                    vel = map(fsr, 50, 4000, 10, 127); vel = constrain(vel, 1, 127);
                  }
                  sendMidi(0x90, note, vel);
                } else sendMidi(0x80, note, 0);
                lastKeyState[r][c] = pressed;
              }
            }
          }
        }

        void scan165() {
          digitalWrite(PIN_165_LOAD, LOW); delayMicroseconds(5); digitalWrite(PIN_165_LOAD, HIGH);
          uint32_t raw = 0;
          for(int i=0; i<32; i++) {
            raw = (raw << 1) | digitalRead(PIN_165_DATA);
            digitalWrite(PIN_165_CLK, HIGH); digitalWrite(PIN_165_CLK, LOW);
          }
          if (raw != lastBtn165) {
            for (int i=0; i<32; i++) {
              int bitNow = (raw >> (31-i)) & 1;
              int bitLast = (lastBtn165 >> (31-i)) & 1;
              if (bitNow == 1 && bitLast == 0) {
                if(i==0) { velocityOn = !velocityOn; sendMidi(0xB0, 120, velocityOn?127:0); }
                else if(i==1) sendMidi(0xB0, 64, 127);
                else if(i==2) { tremoloMode = !tremoloMode; sendMidi(0xB0, 121, tremoloMode?127:0); }
                else sendMidi(0x90, 50+i, 100);
              } else if (bitNow == 0 && bitLast == 1 && i > 2) sendMidi(0x80, 50+i, 0);
            }
            lastBtn165 = raw;
          }
        }

        void scanAnalog() {
          int x = analogRead(PIN_JOY_X);
          if(abs(x - lastJoyX) > 15) {
            if (tremoloMode == 0) {
              int pb = map(x, 0, 4095, 0, 16383);
              MyMidi.sendPitchBend(0, pb);
              SerialBT.write(0xE0); SerialBT.write(pb & 0x7F); SerialBT.write(pb >> 7);
              digitalWrite(PIN_LED, HIGH); tLed = millis(); 
            } else sendMidi(0xB0, 1, map(x, 0, 4095, 0, 127));
            lastJoyX = x;
          }
          int y = analogRead(PIN_JOY_Y);
          if(abs(y - lastJoyY) > 15) { sendMidi(0xB0, 2, map(y, 0, 4095, 0, 127)); lastJoyY = y; }
          for(int i=0; i<8; i++) {
            digitalWrite(MUX_S0, i&1); digitalWrite(MUX_S1, i&2); digitalWrite(MUX_S2, i&4);
            delayMicroseconds(30);
            int val = analogRead(PIN_MUX_IN);
            if(abs(val - lastFader[i]) > 15) {
              int cc = (i<7) ? 16+i : 8; 
              sendMidi(0xB0, cc, map(val,0,4095,0,127)); lastFader[i] = val;
            }
          }
          int mv = analogRead(PIN_MASTER_VOL);
          if(abs(mv - lastVol) > 15) { sendMidi(0xB0, 7, map(mv,0,4095,0,127)); lastVol = mv; }
          if(encoderVal != 0) { globalTranspose += encoderVal; encoderVal = 0; digitalWrite(PIN_LED, HIGH); tLed = millis(); }
        }

        // --- LOOP ---
        void loop() {
          unsigned long now = millis();
          scanMatrix595();
          if (now - tScan > 5) { scan165(); tScan = now; }
          if (now - tAnalog > 15) { scanAnalog(); tAnalog = now; }
          if (digitalRead(PIN_LED) == HIGH && now - tLed > 30) digitalWrite(PIN_LED, LOW);
        }
        EOF

    # --- 3. INSTALL CORE ---
    - name: Install STM32 Core
      run: |
        arduino-cli config init
        arduino-cli config add board_manager.additional_urls http://dan.drown.org/stm32duino/package_STM32duino_index.json
        arduino-cli core update-index
        arduino-cli core install stm32duino:STM32F1

    # --- 4. INSTALL LIBRARY & CLEAN CONFLICT ---
    - name: Install Library & Clean Conflict
      run: |
        mkdir -p libraries
        git clone https://github.com/arpruss/USBComposite_stm32f1.git libraries/USBComposite_stm32f1
        echo "Menghapus library bawaan..."
        rm -rf /home/runner/.arduino15/packages/stm32duino/hardware/STM32F1/*/libraries/USBComposite

    # --- 5. COMPILE ---
    - name: Compile Sketch
      run: |
        arduino-cli compile --fqbn stm32duino:STM32F1:genericSTM32F103C:device_variant=STM32F103C8,upload_method=STLinkMethod,cpu_speed=speed_72mhz \
        --build-property "build.extra_flags=-DUSB_COMPOSITE" \
        --libraries libraries \
        --output-dir build \
        MidiV7/MidiV7.ino

    - name: Upload Firmware Artifact
      uses: actions/upload-artifact@v4
      with:
        name: stm32-midi-firmware
        path: build/
