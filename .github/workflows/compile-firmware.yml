name: Compile STM32 MIDI V14 (Manual Core)

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Arduino CLI
      uses: arduino/setup-arduino-cli@v1.1.2

    # --- 1. PERBAIKI FOLDER ---
    - name: Fix Folder Structure
      run: |
        mkdir -p MidiV7
        if [ -f "MidiV7.ino" ]; then
          mv MidiV7.ino MidiV7/MidiV7.ino
        elif [ -f "main.cpp" ]; then
          mv main.cpp MidiV7/MidiV7.ino
        fi

    # --- 2. INSTALL TOOLS (Compiler) ---
    # Kita install core dummy cuma buat dapetin tool 'arm-none-eabi-gcc'
    - name: Install Compiler Tools
      run: |
        arduino-cli config init
        arduino-cli config add board_manager.additional_urls http://dan.drown.org/stm32duino/package_STM32duino_index.json
        arduino-cli core update-index
        arduino-cli core install stm32duino:STM32F1

    # --- 3. INSTALL CORE SECARA MANUAL (Git Clone) ---
    # Ini langkah kuncinya. Kita download Core Roger Clark yang ASLI.
    # Kita taruh di folder 'hardware' agar terbaca sebagai core manual.
    - name: Install Roger Clark Core Manual
      run: |
        mkdir -p $HOME/.arduino15/packages/arduino/hardware/STM32F1/1.0.0
        git clone https://github.com/rogerclarkmelbourne/Arduino_STM32.git hardware/Arduino_STM32
        
        # Hapus core stm32duino yang tadi (biar gak bentrok) tapi sisakan tools-nya
        # Atau kita cukup gunakan FQBN yang berbeda.

    # --- 4. INSTALL LIBRARY & BERSIHKAN KONFLIK ---
    - name: Install Library USBComposite
      run: |
        mkdir -p libraries
        git clone https://github.com/arpruss/USBComposite_stm32f1.git libraries/USBComposite_stm32f1
        
        # Hapus library bawaan jika ada (safety)
        rm -rf hardware/Arduino_STM32/STM32F1/libraries/USBComposite

    # --- 5. COMPILE (FQBN Manual) ---
    - name: Compile Sketch
      run: |
        # Perhatikan FQBN-nya beda!
        # Bukan 'stm32duino:...', tapi 'Arduino_STM32:STM32F1:genericSTM32F103C'
        # Ini menunjuk ke core yang baru kita download manual.
        # Menu 'usb=composite' DIJAMIN ADA di core ini.
        
        arduino-cli compile --fqbn Arduino_STM32:STM32F1:genericSTM32F103C:device_variant=STM32F103C8,upload_method=STLinkMethod,cpu_speed=speed_72mhz,usb=composite \
        --libraries libraries \
        --output-dir build \
        MidiV7/MidiV7.ino

    - name: Upload Firmware Artifact
      uses: actions/upload-artifact@v4
      with:
        name: stm32-midi-firmware
        path: build/
