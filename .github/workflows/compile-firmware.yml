name: Compile STM32 MIDI V16 (Diagnostic)

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    # UPDATE PENTING: Pakai CLI versi terbaru (v2) bukan v1.1.2
    - name: Setup Arduino CLI
      uses: arduino/setup-arduino-cli@v2

    # --- 1. AUTO-FIX FOLDER ---
    - name: Fix Folder Structure
      run: |
        mkdir -p MidiV7
        if [ -f "MidiV7.ino" ]; then
          mv MidiV7.ino MidiV7/MidiV7.ino
        elif [ -f "main.cpp" ]; then
          mv main.cpp MidiV7/MidiV7.ino
        fi

    # --- 2. INSTALL CORE ---
    - name: Install STM32 Core (Roger Clark)
      run: |
        arduino-cli config init
        arduino-cli config add board_manager.additional_urls http://dan.drown.org/stm32duino/package_STM32duino_index.json
        arduino-cli core update-index
        arduino-cli core install stm32duino:STM32F1

    # --- 3. CEK MENU (WAJIB DIBUKA LOG-NYA) ---
    # Jika compile di bawah gagal, KLIK langkah ini di GitHub Actions.
    # Foto daftar tulisan yang muncul. Itu kunci jawabannya.
    - name: DEBUG - SHOW VALID OPTIONS
      run: |
        echo "=== DAFTAR BOARD ==="
        arduino-cli board listall stm32duino
        echo ""
        echo "=== MENU YANG TERSEDIA ==="
        arduino-cli board details -b stm32duino:STM32F1:genericSTM32F103C

    # --- 4. INSTALL LIBRARY & CLEAN CONFLICT ---
    - name: Install Library & Clean Conflict
      run: |
        mkdir -p libraries
        git clone https://github.com/arpruss/USBComposite_stm32f1.git libraries/USBComposite_stm32f1
        
        echo "Menghapus library bawaan..."
        rm -rf /home/runner/.arduino15/packages/stm32duino/hardware/STM32F1/*/libraries/USBComposite

    # --- 5. COMPILE (SAFE MODE) ---
    - name: Compile Sketch
      run: |
        # KITA PAKAI VARIAN C8 (Standar)
        # HAPUS opsi 'usb' dan 'pnum' dari FQBN.
        # Kita paksa USB lewat --build-property.
        
        arduino-cli compile --fqbn stm32duino:STM32F1:genericSTM32F103C:device_variant=STM32F103C8,upload_method=STLinkMethod,cpu_speed=speed_72mhz \
        --build-property "build.extra_flags=-DUSB_COMPOSITE" \
        --libraries libraries \
        --output-dir build \
        MidiV7/MidiV7.ino

    - name: Upload Firmware Artifact
      uses: actions/upload-artifact@v4
      with:
        name: stm32-midi-firmware
        path: build/
